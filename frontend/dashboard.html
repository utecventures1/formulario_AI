<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Dashboard de Startups</title>
  <!-- A√±adimos la librer√≠a para crear Excel (SheetJS) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    /* Estilos (sin cambios) */
    :root {
      --bg-color: #f8fafc; --text-color: #1e293b; --primary-color: #2563eb;
      --secondary-text: #f50a0a; --card-bg: #ffffff; --border-color: #e2e8f0;
      --success-color: #16a34a; --warning-color: #f59e0b; --radius: 12px;
      --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      background-color: var(--bg-color); color: var(--text-color); margin: 0; padding: 30px;
    }
    h2 { font-size: 1.8rem; font-weight: 700; margin-bottom: 20px; }
    #download-btn { background-color: var(--success-color); color: white; border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; font-weight: 600;}
    .dashboard-container { background: var(--card-bg); border-radius: var(--radius); box-shadow: var(--shadow); padding: 20px; overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
    th, td { padding: 14px 12px; text-align: left; border-bottom: 1px solid var(--border-color); }
    th { background: #f1f5f9; font-weight: 600; color: #334155; }
    .score-box { background: #eef2ff; border-radius: 8px; padding: 5px 10px; font-weight: 500; color: #1e3a8a; text-align: center; display: inline-block; min-width: 30px; }
    .action-link { color: var(--primary-color); cursor: pointer; font-weight: 500; }
    #side-panel {
    position: fixed;
    top: 0;
    right: -440px; /* antes -450px */
    width: 440px;  /* ajustado */
    height: 100%;
    background: white;
    box-shadow: -2px 0 15px rgba(0, 0, 0, 0.1);
    overflow-y: auto;
    padding: 32px 28px 60px 28px; /* m√°s c√≥modo */
    transition: right 0.35s ease;
    border-top-left-radius: 16px;
    border-bottom-left-radius: 16px;
    box-sizing: border-box; /* evita desbordes */
    scrollbar-width: thin;
    scrollbar-color: #cbd5e1 #f8fafc;
    z-index: 100;
  }
   #side-panel::-webkit-scrollbar {
    width: 8px;
  }
  #side-panel::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 10px;
  }
  #side-panel::-webkit-scrollbar-thumb:hover {
    background: #94a3b8;
  }
    #side-panel.open { right: 0; }
    #close-panel-btn {
    background: #ef4444;
    color: white;
    border: none;
    padding: 8px 14px;
    border-radius: 8px;
    cursor: pointer;
    float: right;
    font-weight: 600;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    transition: background 0.2s ease, transform 0.1s ease;
  }
  #close-panel-btn:hover {
    background: #dc2626;
    transform: scale(1.04);
  }
    /* Smooth transitions for interactive elements */
    #download-btn, #save-changes-btn, #home-btn, #close-panel-btn, #resume-modal .btn, .toast .toast-close, .action-link {
      transition: transform 180ms cubic-bezier(.2,.9,.2,1),
                  box-shadow 180ms cubic-bezier(.2,.9,.2,1),
                  background 180ms cubic-bezier(.2,.9,.2,1),
                  color 180ms cubic-bezier(.2,.9,.2,1),
                  filter 180ms cubic-bezier(.2,.9,.2,1);
      will-change: transform, box-shadow, background, color;
    }

    /* Hover states for interactive controls */
    #download-btn:hover,
    #save-changes-btn:hover {
      transform: translateY(-1px) scale(1.02);
      box-shadow: 0 8px 20px rgba(37,99,235,0.12);
      filter: brightness(1.03);
    }
    /* Make modal buttons have subtle hover */
    #resume-modal .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 18px rgba(37,99,235,0.12);
    }
    #resume-modal .btn-secondary:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 14px rgba(2,6,23,0.06);
    }
    /* Toast close hover */
    .toast .toast-close:hover {
      background: rgba(255,255,255,0.18);
      transform: scale(1.06);
    }
    /* Action links hover */
    .action-link:hover {
      text-decoration: underline;
      color: #1d4ed8; /* slightly darker blue */
    }
 #side-panel h3 {
    margin-top: 15px;
    margin-bottom: 18px;
    font-size: 1.5rem;
    line-height: 1.3;
    color: var(--text-color);
  }

  #side-panel h4 {
    margin-top: 28px;
    margin-bottom: 10px;
    color: var(--primary-color);
    font-size: 1.05rem;
    font-weight: 700;
  }
      .panel-section {
    margin-bottom: 30px;
  }

  .panel-section p {
    margin-bottom: 12px;
    line-height: 1.6;
  }

  .label {
    font-weight: 600;
    color: var(--secondary-text);
  }

  th.sortable-header {
      cursor: pointer;
      transition: background-color 0.2s ease;
      position: relative;
      padding-right: 28px; 
    }

    th.sortable-header:hover {
      background-color: #e2e8f0; /* Un color de fondo ligeramente m√°s oscuro al pasar el rat√≥n */
    }

    th.sortable-header::after {
      content: '‚Üï'; /* Car√°cter de flecha arriba-abajo */
      position: absolute;
      right: 12px; /* Distancia desde la derecha */
      top: 50%;
      transform: translateY(-50%); /* Centrado vertical perfecto */
      color: #94a3b8; /* Color sutil para el √≠cono */
      font-size: 0.9em;
    }

    th.sortable-header.sorted-asc::after,
    th.sortable-header.sorted-desc::after {
      color: var(--text-color); /* Color m√°s oscuro para el √≠cono activo */
    }
    
    th.sortable-header.sorted-asc::after {
      content: '‚Üë'; /* Flecha hacia arriba */
    }

    th.sortable-header.sorted-desc::after {
      content: '‚Üì'; /* Flecha hacia abajo */
    }

    .controls-container {
      display: flex;
      gap: 15px; /* Espacio entre elementos */
      margin-bottom: 20px;
      align-items: center;
    }

    /* Botones reutilizables (mejor dise√±o global) */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 10px;
      border: 1px solid transparent;
      font-weight: 600;
      cursor: pointer;
      background: transparent;
      transition: transform 160ms ease, box-shadow 160ms ease, background 160ms ease;
    }
    .btn:focus { outline: none; box-shadow: 0 6px 18px rgba(37,99,235,0.12); }
    .btn-primary { background: var(--primary-color); color: white; border-color: rgba(37,99,235,0.12); }
    .btn-secondary { background: #e6eefb; color: #0f172a; border-color: rgba(2,6,23,0.04); }
    /* Home button specific tweaks to make it visually consistent */
    #home-btn { font-size: 0.95rem; padding: 9px 14px; box-shadow: 0 4px 10px rgba(2,6,23,0.04); }
    #home-btn:hover { transform: translateY(-2px); box-shadow: 0 10px 26px rgba(2,6,23,0.08); }

    /* --- NUEVO: ESTILOS PARA LOS CAMPOS DE B√öSQUEDA --- */
    .search-input {
      padding: 10px 15px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      font-size: 0.9rem;
      width: 220px;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }
    .search-input:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
    }

    #save-changes-btn {
      background-color: var(--primary-color);
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
    }
    .editable-score {
      cursor: pointer;
      transition: background-color 0.2s, box-shadow 0.2s;
    }
    .editable-score:focus {
      background-color: white;
      outline: none;
      box-shadow: 0 0 0 2px var(--primary-color);
    }

    /* Toast (notificaci√≥n) */
    #toast-container {
      position: fixed;
      right: 20px;
      bottom: 20px;
      z-index: 110;
      display: flex;
      flex-direction: column;
      gap: 12px;
      pointer-events: none; /* permitir clicks a elementos debajo cuando no hay toast */
    }
    .toast {
      pointer-events: auto;
      min-width: 240px;
      max-width: 360px;
      background: #16a34a; /* success por defecto */
      color: white;
      padding: 12px 14px;
      border-radius: 10px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.12);
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 600;
      transform: translateY(12px);
      opacity: 0;
      animation: toast-in 260ms ease forwards;
    }
    .toast.toast--error { background: #dc2626; }
    .toast .toast-close {
      margin-left: auto;
      background: rgba(255,255,255,0.12);
      border: none;
      color: white;
      padding: 6px 8px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 700;
    }

    .actions-cell {
    display: flex;
    align-items: center;
    gap: 8px; /* Espacio entre "Ver m√°s" y el bot√≥n */
}

    .rerun-btn {
        background: none;
        border: none;
        cursor: pointer;
        font-size: 1.2rem;
        padding: 2px;
        border-radius: 4px;
        line-height: 1;
        transition: background-color 0.2s, transform 0.2s;
    }

    .rerun-btn:hover {
        background-color: #e2e8f0; /* Un fondo sutil al pasar el mouse */
        transform: scale(1.1);
    }

    .rerun-btn:disabled {
        cursor: not-allowed;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }

    @keyframes toast-in {
      from { transform: translateY(12px); opacity: 0 }
      to { transform: translateY(0); opacity: 1 }
    }
    @keyframes toast-out {
      from { transform: translateY(0); opacity: 1 }
      to { transform: translateY(8px); opacity: 0 }
    }

    /* --- RESPONSIVE --- */
    @media (max-width: 1024px) {
      body { padding: 18px; }
      .dashboard-container { padding: 16px; }
      table { font-size: 0.88rem; }
      th, td { padding: 10px 8px; }
      .score-box { padding: 6px 8px; min-width: 24px; }
    }

    @media (max-width: 768px) {
      .controls-container { flex-direction: column; gap: 10px; align-items: stretch; }
      .controls-container .search-input { width: 100%; }
      #download-btn, #save-changes-btn, #home-btn { width: 100%; }
      .dashboard-container { padding: 12px; }
      table { display: block; width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch; }
      th, td { white-space: nowrap; }
      /* Side panel becomes full width on small screens */
      #side-panel { width: 100%; right: -100%; border-top-left-radius: 0; border-bottom-left-radius: 0; }
      #side-panel.open { right: 0; }
      #close-panel-btn { float: none; display: inline-block; width: auto; }
      /* Toasts adapt to smaller screens */
      #toast-container { right: 10px; left: 10px; bottom: 12px; align-items: center; }
      .toast { width: 100%; max-width: none; min-width: 0; }
    }

    @media (max-width: 420px) {
      h2 { font-size: 1.3rem; }
      th, td { padding: 8px 6px; }
      .score-box { padding: 6px 6px; font-size: 0.9rem; }
      .action-link { font-size: 0.95rem; }
      #side-panel { padding: 18px 14px 40px 14px; }
    }

    /* Modal de reanudaci√≥n */
    /* Modal (uses opacity+transform so open/close can animate smoothly) */
    #resume-modal {
      position: fixed; inset: 0; display: flex; align-items: center; justify-content: center; z-index: 120;
      opacity: 0; pointer-events: none; visibility: hidden;
      transition: opacity 220ms cubic-bezier(.2,.9,.2,1), visibility 220ms linear;
    }
    #resume-modal.open { opacity: 1; pointer-events: auto; visibility: visible; }
    #resume-modal .backdrop { position: absolute; inset: 0; background: rgba(2,6,23,0.45); opacity: 0; transition: opacity 220ms ease; }
    #resume-modal.open .backdrop { opacity: 1; }
    #resume-modal .modal-card {
      position: relative; background: white; border-radius: 12px; padding: 20px; max-width: 520px; width: calc(100% - 40px);
      box-shadow: 0 12px 40px rgba(2,6,23,0.2);
      transform: translateY(8px) scale(0.995); opacity: 0;
      transition: transform 240ms cubic-bezier(.2,.9,.2,1), opacity 220ms ease;
    }
    #resume-modal.open .modal-card { transform: translateY(0) scale(1); opacity: 1; }
    #resume-modal h3 { margin: 0 0 8px 0; }
    #resume-modal p { margin: 0 0 16px 0; color: var(--secondary-text); }
    #resume-modal .modal-actions { display:flex; gap:10px; justify-content:flex-end; }
    #resume-modal .btn { padding: 8px 12px; border-radius: 8px; border: none; cursor: pointer; font-weight:600 }
    #resume-modal .btn-secondary { background: #e2e8f0; color: #0f172a }
    #resume-modal .btn-primary { background: var(--primary-color); color: white }

  </style>
</head>

<body>
  <h2>üìä Dashboard de Startups</h2>
  <div class="controls-container">
    <input type="text" id="search-name" class="search-input" placeholder="Buscar por nombre...">
    <input type="text" id="search-industry" class="search-input" placeholder="Buscar por industria...">
    <button id="download-btn" style="display:none;">Descargar Resultados en Excel</button>
    <button id="save-changes-btn" style="display:none;">Guardar Cambios</button>
    <button id="home-btn" class="btn btn-secondary" title="Ir al inicio" aria-label="Ir al inicio">üè† Ir al inicio</button>

  </div>
  <div class="dashboard-container">
    <table id="dashboard-table">
      <thead>
        <!-- CORRECCI√ìN 1: Se elimina la columna "Resumen" -->
        <tr>
          <!-- A√ëADIMOS data-sort-key para identificar cada columna -->
          <th class="sortable-header" data-sort-key="nombre">Nombre</th>
          <th class="sortable-header" data-sort-key="industria">Industria</th>
          <th class="sortable-header" data-sort-key="equipo">Equipo</th>
          <th class="sortable-header" data-sort-key="producto">Producto</th>
          <th class="sortable-header" data-sort-key="tesis_utec">Tesis UTEC</th>
          <th class="sortable-header" data-sort-key="oportunidad">Oportunidad</th>
          <th class="sortable-header" data-sort-key="validacion">Validaci√≥n</th>
          <th class="sortable-header" data-sort-key="puntaje_final">Puntaje Final</th>
          <th>Acci√≥n</th>
        </tr>
      </thead>
      <tbody id="startups-table-body"></tbody>
    </table>
  </div>

  <div id="side-panel">
    <button id="close-panel-btn">Cerrar</button>
    <h3 id="panel-startup-name"></h3>
    
    <!-- CORRECCI√ìN 2: Se eliminan "Industria" y "Puntajes" de aqu√≠ -->
    
    <h4>An√°lisis Cualitativo</h4>
    <div class="panel-section">
      <!-- CORRECCI√ìN 3: "Resumen" (Tesis del Proyecto) ahora est√° aqu√≠ -->
      <p><span class="label">Tesis del Proyecto:</span> <span id="panel-qualitative-thesis"></span></p>
      <p><span class="label">Problema:</span> <span id="panel-qualitative-problem"></span></p>
      <p><span class="label">Soluci√≥n:</span> <span id="panel-qualitative-solution"></span></p>
      <p><span class="label">M√©tricas Clave:</span> <span id="panel-qualitative-metrics"></span></p>
      <p><span class="label">Equipo Fundador:</span> <span id="panel-qualitative-team"></span></p>
      <p><span class="label">Mercado y Competencia:</span> <span id="panel-qualitative-market"></span></p>
    </div>

    <h4>Justificaci√≥n de Puntajes</h4>
    <div class="panel-section">
        <p><span class="label">Equipo:</span> <span id="panel-justification-equipo"></span></p>
        <p><span class="label">Tesis UTEC:</span> <span id="panel-justification-tesis-utec"></span></p>
        <p><span class="label">Oportunidad:</span> <span id="panel-justification-oportunidad"></span></p>
        <p><span class="label">Validaci√≥n:</span> <span id="panel-justification-validacion"></span></p>
    </div>
  </div>

  <!-- Contenedor para toasts/notificaciones -->
  <div id="toast-container" aria-live="polite" aria-atomic="true"></div>

  <!-- Modal para reanudar an√°lisis si hay datos en localStorage -->
  <div id="resume-modal" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="backdrop"></div>
    <div class="modal-card" role="document">
      <h3>Continuar an√°lisis existente</h3>
      <p style="color:#334155">Se encontraron resultados guardados en este navegador. ¬øQuieres continuar con este an√°lisis o empezar de nuevo?</p>
      <div class="modal-actions">
        <button class="btn btn-secondary btn-no">No, volver</button>
        <button class="btn btn-primary btn-continue">Continuar</button>
      </div>
    </div>
  </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- DECLARACI√ìN DE VARIABLES Y CONSTANTES ---
    const table = document.getElementById('dashboard-table');
    const tableBody = document.getElementById('startups-table-body');
    const downloadBtn = document.getElementById('download-btn');
    const searchNameInput = document.getElementById('search-name');
    const searchIndustryInput = document.getElementById('search-industry');
    const saveChangesBtn = document.getElementById('save-changes-btn');
    
    let startupData = [];
    let currentSortKey = 'puntaje_final'; // Ordenar por puntaje por defecto
    let sortDirection = 'desc';

    let SCORING_WEIGHTS = {};

    async function loadConfigAndInitialize() {
        try {
            const response = await fetch('/api/config/scoring-weights');
            if (!response.ok) throw new Error('Failed to load config');
            SCORING_WEIGHTS = await response.json();
            console.log("Pesos cargados:", SCORING_WEIGHTS);
            
            // Ahora ejecuta la l√≥gica que ten√≠as al principio
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('startAnalysis') === 'true') {
                startRealtimeAnalysis();
            } else {
                const stored = localStorage.getItem('startupResults');
                if (stored) {
                    startupData = JSON.parse(stored);
                    if (startupData.length > 0) showResumeModal();
                }
            }
        } catch (error) {
            showToast('Error al cargar la configuraci√≥n.', 'error');
        }
    }

    function startRealtimeAnalysis() {
        const fileContent = sessionStorage.getItem('analysisFileContent');
        const fileName = sessionStorage.getItem('analysisFileName');
        if (!fileContent) return;

        // Limpiar UI y datos
        startupData = [];
        renderTable(startupData);
        table.style.display = 'table';
        downloadBtn.style.display = 'block';
        saveChangesBtn.style.display = 'block';
        showToast(`Iniciando an√°lisis para ${fileName}...`, 'success');

        const fileBlob = new Blob([fileContent], { type: 'text/csv' });
        const formData = new FormData();
        formData.append('new_deals_file', fileBlob, fileName);
        
        // Limpiar sessionStorage y URL para que no se re-ejecute al recargar
        sessionStorage.removeItem('analysisFileContent');
        sessionStorage.removeItem('analysisFileName');
        window.history.replaceState({}, document.title, window.location.pathname);

        // Usamos fetch para enviar el POST con el header 'Accept: text/event-stream'
        fetch('/api/analyze', {
            method: 'POST',
            body: formData,
            headers: { 'Accept': 'text/event-stream' }
        }).then(response => {
            if (!response.ok) {
                throw new Error(`Error del servidor: ${response.status}`);
            }
            const reader = response.body.getReader();
            const decoder = new TextDecoder();

            function processStream() {
                reader.read().then(({ done, value }) => {
                    if (done) {
                        showToast('An√°lisis en tiempo real completado.', 'success');
                        localStorage.setItem('startupResults', JSON.stringify(startupData));
                        sortData(currentSortKey, true); // Ordenar al final
                        return;
                    }
                    
                    const chunk = decoder.decode(value, { stream: true });
                    const events = chunk.split('\n\n');
                    events.forEach(event => {
                        if (event.startsWith('data:')) {
                            const data = event.substring(5).trim();
                            if (data) {
                                try {
                                    const newStartup = JSON.parse(data);
                                    startupData.push(newStartup);
                                    // No re-ordenamos en cada paso por eficiencia, solo al final.
                                    applyFiltersAndRender();
                                } catch (e) {
                                    console.error("Error al parsear evento del stream:", data, e);
                                }
                            }
                        }
                    });
                    processStream(); // Continuar leyendo el stream
                });
            }
            processStream();
        }).catch(err => {
            console.error('Error en la conexi√≥n de streaming:', err);
            showToast('Error de conexi√≥n durante el an√°lisis.', 'error');
        });
    }

    function showResumeModal() {
        const resumeModal = document.getElementById('resume-modal');
        const continueBtn = resumeModal.querySelector('.btn-continue');
        const noBtn = resumeModal.querySelector('.btn-no');

        resumeModal.classList.add('open');
        try { continueBtn.focus(); } catch (e) {}

        continueBtn.addEventListener('click', () => {
            resumeModal.classList.remove('open');
            proceedWithData();
        }, { once: true });

        noBtn.addEventListener('click', () => {
            localStorage.removeItem('startupResults');
            startupData = [];
            window.location.href = '/';
        }, { once: true });
    }

    // Si hay datos guardados, mostramos un modal para que el usuario elija
    function proceedWithData() {
        table.style.display = 'table';
        downloadBtn.style.display = 'block';
        saveChangesBtn.style.display = 'block';
        sortData(currentSortKey, true); // Forzar ordenamiento inicial
    }

    function renderTable(data) {
        const tableBody = document.getElementById('startups-table-body');
        tableBody.innerHTML = ''; // Limpiar la tabla antes de renderizar
        if (data.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:20px;">No se encontraron startups que coincidan con los filtros.</td></tr>';
            return;
        }

        data.forEach((startup) => {
            // Se busca el √≠ndice original para el panel lateral y el re-an√°lisis
            const originalIndex = startupData.findIndex(original => original === startup);
            const scores = startup.dimensional_scores || {};
            const rowHTML = `
                <tr>
                    <td>${startup['Nombre de la startup'] || 'N/A'}</td>
                    <td>${startup['¬øA qu√© industria(s) pertenece tu startup?'] || 'N/A'}</td>
                    <td><div class="score-box editable-score" contenteditable="true" data-index="${originalIndex}" data-score-key="equipo">${scores.equipo ?? '-'}</div></td>
                    <td><div class="score-box editable-score" contenteditable="true" data-index="${originalIndex}" data-score-key="producto">${scores.producto ?? '-'}</div></td> <!-- A√ëADIDA -->
                    <td><div class="score-box editable-score" contenteditable="true" data-index="${originalIndex}" data-score-key="tesis_utec">${scores.tesis_utec ?? '-'}</div></td>
                    <td><div class="score-box editable-score" contenteditable="true" data-index="${originalIndex}" data-score-key="oportunidad">${scores.oportunidad ?? '-'}</div></td>
                    <td><div class="score-box editable-score" contenteditable="true" data-index="${originalIndex}" data-score-key="validacion">${scores.validacion ?? '-'}</div></td>
                    <td><div class="score-box final-score">${(startup.final_weighted_score || 0).toFixed(2)}</div></td>
                    <td class="actions-cell">
                        <a class="action-link" data-index="${originalIndex}">Ver m√°s</a>
                        <button class="rerun-btn" title="Re-analizar con IA" data-index="${originalIndex}">üîÑ</button>
                    </td>
                </tr>
            `;
            tableBody.innerHTML += rowHTML;
        });
    }

    function recalculateFinalScore(startup) {
      const scores = startup.dimensional_scores || {};
      let finalScore = 0;
      for (const key in SCORING_WEIGHTS) {
        finalScore += (scores[key] || 0) * SCORING_WEIGHTS[key].peso;
      }
      startup.final_weighted_score = finalScore;
    }

    function applyFiltersAndRender() {
      const nameFilter = searchNameInput.value.toLowerCase();
      const industryFilter = searchIndustryInput.value.toLowerCase();

      const filteredData = startupData.filter(startup => {
        const startupName = (startup['Nombre de la startup'] || '').toLowerCase();
        const startupIndustry = (startup['¬øA qu√© industria(s) pertenece tu startup?'] || '').toLowerCase();

        // La startup debe coincidir con ambos filtros
        const nameMatch = startupName.includes(nameFilter);
        const industryMatch = startupIndustry.includes(industryFilter);

        return nameMatch && industryMatch;
      });

      renderTable(filteredData);
    }

    function sortData(key) {
      if (currentSortKey === key) {
        sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
      } else {
        currentSortKey = key;
        sortDirection = 'asc';
      }

      // IMPORTANTE: El ordenamiento se hace sobre el array COMPLETO
      startupData.sort((a, b) => {
        const getValue = (obj, sortKey) => {
          switch (sortKey) {
            case 'nombre': return obj['Nombre de la startup'] || '';
            case 'industria': return obj['¬øA qu√© industria(s) pertenece tu startup?'] || '';
            case 'equipo': return obj.dimensional_scores?.equipo || 0;
            case 'tesis_utec': return obj.dimensional_scores?.tesis_utec || 0;
            case 'oportunidad': return obj.dimensional_scores?.oportunidad || 0;
            case 'validacion': return obj.dimensional_scores?.validacion || 0;
            case 'puntaje_final': return obj.final_weighted_score || 0;
            default: return '';
          }
        };
        const valA = getValue(a, key);
        const valB = getValue(b, key);
        let comparison = 0;
        if (typeof valA === 'number' && typeof valB === 'number') {
          comparison = valA - valB;
        } else {
          comparison = (valA.toString()).localeCompare(valB.toString());
        }
        return sortDirection === 'asc' ? comparison : -comparison;
      });

      // CAMBIO: En lugar de renderizar, aplicamos los filtros actuales a la data ordenada
      applyFiltersAndRender();
      updateHeaderIcons();
    }

    function updateHeaderIcons() {
      const headers = document.querySelectorAll('th.sortable-header');
      headers.forEach(header => {
        header.classList.remove('sorted-asc', 'sorted-desc');
        if (header.dataset.sortKey === currentSortKey) {
          header.classList.add(sortDirection === 'asc' ? 'sorted-asc' : 'sorted-desc');
        }
      });
    }

    document.getElementById('startups-table-body').addEventListener('blur', (e) => {
      const target = e.target;
      if (target.classList.contains('editable-score')) {
        const index = parseInt(target.dataset.index, 10);
        const scoreKey = target.dataset.scoreKey;

        // Permitimos n√∫meros con decimales (parseFloat) y espacios
        const raw = (target.textContent || '').trim();
        const newValue = raw === '' ? NaN : parseFloat(raw);

        if (!isNaN(newValue) && index >= 0 && startupData[index]) {
          // Aseguramos que exista el objeto dimensional_scores
          if (!startupData[index].dimensional_scores) startupData[index].dimensional_scores = {};
          // Actualiza el dato en nuestro array de JavaScript
          startupData[index].dimensional_scores[scoreKey] = newValue;

          // Recalcula el puntaje final para esta startup
          recalculateFinalScore(startupData[index]);

          // Actualiza la celda del puntaje final en la misma fila
          const row = target.closest('tr');
          if (row) {
            const finalCell = row.querySelector('td:nth-child(8) .score-box');
            if (finalCell) finalCell.textContent = (startupData[index].final_weighted_score || 0).toFixed(2);
          }

          console.log(`Cambiado startup[${index}].dimensional_scores.${scoreKey} a ${newValue}`);
        } else {
          // Si el usuario borra el n√∫mero o pone texto inv√°lido, vuelve al valor original
          const original = startupData[index]?.dimensional_scores?.[scoreKey];
          target.textContent = (original !== undefined && original !== null) ? original : '-';
        }
      }
    }, true); // Usamos 'true' para capturar el evento en la fase de captura

    // Evita que se inserten caracteres no num√©ricos y hace que Enter termine la edici√≥n
    document.getElementById('startups-table-body').addEventListener('keydown', (e) => {
      const target = e.target;
      if (!target.classList || !target.classList.contains('editable-score')) return;

      // Permitir combinaciones con Ctrl/Cmd (copiar/pegar, seleccionar todo)
      if (e.ctrlKey || e.metaKey) return;

      // Si presiona Enter: evitar salto de l√≠nea, salir de la edici√≥n (blur) para disparar el handler de guardado
      if (e.key === 'Enter') {
        e.preventDefault();
        target.blur();
        return;
      }

      // Teclas de control aceptadas (navegaci√≥n, borrar)
      const allowedKeys = ['Backspace', 'Delete', 'ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown', 'Home', 'End', 'Tab'];
      if (allowedKeys.includes(e.key)) return;

      // Solo permitir d√≠gitos y un punto decimal
      if (!/^[0-9.]$/.test(e.key)) {
        e.preventDefault();
      }
      // Si ya existe un punto y el usuario intenta escribir otro, bloquearlo
      if (e.key === '.' && (target.textContent || '').includes('.')) {
        e.preventDefault();
      }
    }, true);

    // Tambi√©n sanitizar pegados/entradas para mantener solo n√∫meros y un punto
    document.getElementById('startups-table-body').addEventListener('input', (e) => {
      const target = e.target;
      if (!target.classList || !target.classList.contains('editable-score')) return;

      const raw = (target.textContent || '');
      // Eliminar todo excepto d√≠gitos y puntos
      let cleaned = raw.replace(/[^0-9.]/g, '');
      // Mantener solo el primer punto
      const parts = cleaned.split('.');
      if (parts.length > 1) {
        cleaned = parts.shift() + '.' + parts.join('');
      }
      if (cleaned !== raw) {
        target.textContent = cleaned;
        // Mover el cursor al final
        const sel = window.getSelection();
        const range = document.createRange();
        range.selectNodeContents(target);
        range.collapse(false);
        sel.removeAllRanges();
        sel.addRange(range);
      }
    }, true);

    // Event listener para el bot√≥n "Guardar Cambios"
    saveChangesBtn.addEventListener('click', () => {
      // Recalcula todos los puntajes finales
      startupData.forEach(startup => recalculateFinalScore(startup));
      
      // Guarda el array actualizado en localStorage
      localStorage.setItem('startupResults', JSON.stringify(startupData));

      // Vuelve a ordenar y renderizar la tabla para mostrar los cambios
      sortData(currentSortKey, true);
      // Mostrar toast agradable en lugar de alert()
      showToast('¬°Cambios guardados exitosamente!', 'success');
    });

    // --- NUEVO: ASIGNACI√ìN DE EVENTOS A LOS ENCABEZADOS ---
    const headers = document.querySelectorAll('th.sortable-header');
    headers.forEach(header => {
      header.addEventListener('click', () => {
        sortData(header.dataset.sortKey);
      });
    });

    searchNameInput.addEventListener('input', applyFiltersAndRender);
    searchIndustryInput.addEventListener('input', applyFiltersAndRender);

tableBody.addEventListener('click', async (e) => {
    const target = e.target;

    // L√≥gica existente para el enlace "Ver m√°s" (abrir panel lateral)
    if (target.classList.contains('action-link')) {
        openSidePanel(target.getAttribute('data-index'));
        return; // Detenemos la ejecuci√≥n para no hacer nada m√°s
    }

    // NUEVA L√ìGICA para el bot√≥n "Re-analizar" (el üîÑ)
    if (target.classList.contains('rerun-btn')) {
        const index = parseInt(target.getAttribute('data-index'), 10);
        if (isNaN(index) || !startupData[index]) {
            console.error("√çndice inv√°lido para re-an√°lisis:", index);
            return;
        }

        // Hacemos una copia del objeto para no modificar el original en caso de error
        const startupToRerun = { ...startupData[index] };
        
        // Deshabilitar bot√≥n y mostrar estado de carga visualmente
        target.disabled = true;
        target.textContent = '‚è≥';
        target.title = 'Re-analizando...';
        
        try {
            const response = await fetch('/api/rerun-analysis', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(startupToRerun)
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ detail: 'Error desconocido del servidor.' }));
                throw new Error(errorData.detail || `Error del servidor: ${response.status}`);
            }

            const updatedStartup = await response.json();
            
            // Actualizar los datos en nuestro array principal con la nueva informaci√≥n
            startupData[index] = updatedStartup;
            
            // Volver a renderizar toda la tabla. 
            // Esto es importante para que se apliquen los filtros y el ordenamiento actual.
            applyFiltersAndRender();
            
            showToast('¬°Startup re-analizada con √©xito!', 'success');

        } catch (error) {
            console.error('Error al re-analizar:', error);
            showToast(`Error: ${error.message}`, 'error');
            
            // Re-habilitar el bot√≥n en la interfaz en caso de error
            // Lo buscamos de nuevo por si la tabla se re-renderiz√≥
            const failedButton = tableBody.querySelector(`button.rerun-btn[data-index="${index}"]`);
            if (failedButton) {
                failedButton.disabled = false;
                failedButton.textContent = 'üîÑ';
                failedButton.title = 'Re-analizar con IA';
            }
        }
    }
});


    function openSidePanel(index) {
        const s = startupData[index];
        const scores = s.dimensional_scores || {};
        const analysis = s.qualitative_analysis || {};
        const justifications = s.score_justification || {};

        document.getElementById('panel-startup-name').textContent = s['Nombre de la startup'] || 'Sin nombre';
        
        // CORRECCI√ìN 2 (JS): Se eliminan las l√≠neas que llenaban Industria y Puntajes en el panel
        
        document.getElementById('panel-qualitative-thesis').textContent = analysis.project_thesis || '';
        document.getElementById('panel-qualitative-problem').textContent = analysis.problem || '';
        document.getElementById('panel-qualitative-solution').textContent = analysis.solution || '';
        document.getElementById('panel-qualitative-metrics').textContent = analysis.key_metrics || '';
        document.getElementById('panel-qualitative-team').textContent = analysis.founding_team || '';
        document.getElementById('panel-qualitative-market').textContent = analysis.market_and_competition || '';

        document.getElementById('panel-justification-equipo').textContent = justifications.equipo || '';
        document.getElementById('panel-justification-tesis-utec').textContent = justifications.tesis_utec || '';
        document.getElementById('panel-justification-oportunidad').textContent = justifications.oportunidad || '';
        document.getElementById('panel-justification-validacion').textContent = justifications.validacion || '';
        
        document.getElementById('side-panel').classList.add('open');

        const panel = document.getElementById('side-panel');
        panel.classList.add('open');
        panel.scrollTop = 0;
    }
    
    // La funci√≥n de descarga no necesita cambios, ya exporta todo
    function downloadExcel() {
        if (!startupData || startupData.length === 0) return;
        
        const flattenedData = startupData.map(s => {
            const scores = s.dimensional_scores || {};
            const analysis = s.qualitative_analysis || {};
            const justifications = s.score_justification || {};
            const flatStartup = {
                "Nombre Startup": s['Nombre de la startup'],
                "Puntaje Final": s.final_weighted_score,
                "Industria": s['¬øA qu√© industria(s) pertenece tu startup?'],
                "Puntaje Equipo": scores.equipo, "Puntaje Producto": scores.producto,
                "Puntaje Tesis UTEC": scores.tesis_utec, "Puntaje Oportunidad": scores.oportunidad,
                "Puntaje Validacion": scores.validacion,
                "An√°lisis - Tesis del Proyecto": analysis.project_thesis, "An√°lisis - Problema": analysis.problem,
                "An√°lisis - Soluci√≥n": analysis.solution, "An√°lisis - M√©tricas Clave": analysis.key_metrics,
                "An√°lisis - Equipo Fundador": analysis.founding_team, "An√°lisis - Mercado y Competencia": analysis.market_and_competition,
                "Justificaci√≥n - Equipo": justifications.equipo, "Justificaci√≥n - Tesis UTEC": justifications.tesis_utec,
                "Justificaci√≥n - Oportunidad": justifications.oportunidad, "Justificaci√≥n - Validaci√≥n": justifications.validacion,
                ...s 
            };
            delete flatStartup.dimensional_scores; delete flatStartup.qualitative_analysis; delete flatStartup.score_justification;
            return flatStartup;
        });
        const worksheet = XLSX.utils.json_to_sheet(flattenedData);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "Resultados Scoring");
        XLSX.writeFile(workbook, "resultados_scoring.xlsx");
    }

    document.getElementById('close-panel-btn').addEventListener('click', () => {
      document.getElementById('side-panel').classList.remove('open');
    });
    // Cerrar el panel lateral al hacer click fuera de √©l
    document.addEventListener('click', (e) => {
      const panel = document.getElementById('side-panel');
      if (!panel.classList.contains('open')) return; // Si no est√° abierto, nada que hacer
      const target = e.target;
      // Si el click ocurri√≥ dentro del panel, no cerramos
      if (panel.contains(target)) return;
      // Si el click fue en un enlace de acci√≥n que abre el panel, ignorarlo para evitar cierres inmediatos
      if (target.classList && target.classList.contains('action-link')) return;
      panel.classList.remove('open');
    });
    downloadBtn.addEventListener('click', downloadExcel);

    // Home button: navegar a la p√°gina local index.html (NO redirige a '/')
    const homeBtn = document.getElementById('home-btn');
    if (homeBtn) {
      homeBtn.addEventListener('click', (e) => {
        e.preventDefault();
        // Navegar a la p√°gina de inicio ubicada en el mismo directorio
        window.location.href = 'index.html';
      });
    }

    // -- Funciones de Toast --
    function showToast(message, type = 'success', timeout = 3500) {
      const container = document.getElementById('toast-container');
      if (!container) return;
      const toast = document.createElement('div');
      toast.className = 'toast' + (type === 'error' ? ' toast--error' : '');
      toast.setAttribute('role', 'status');
      toast.innerHTML = `<div class="toast-message">${message}</div><button class="toast-close" aria-label="Cerrar">‚úï</button>`;

      // cerrar al hacer clic en la X
      toast.querySelector('.toast-close').addEventListener('click', () => removeToast(toast));

      container.appendChild(toast);

      const removeAfter = () => {
        toast.style.animation = 'toast-out 200ms ease forwards';
        setTimeout(() => removeToast(toast), 220);
      };

      const timeoutId = setTimeout(removeAfter, timeout);

      // Quitar al pasar mouse (opcional) ‚Äî si el usuario interact√∫a, cancelamos cierre autom√°tico
      toast.addEventListener('mouseenter', () => clearTimeout(timeoutId));
      toast.addEventListener('mouseleave', () => setTimeout(removeAfter, 1200));
    }

    function removeToast(toast) {
      if (!toast || !toast.parentElement) return;
      try { toast.style.animation = 'toast-out 160ms ease forwards'; } catch (e) {}
      setTimeout(() => { if (toast.parentElement) toast.parentElement.removeChild(toast); }, 200);
    }

    loadConfigAndInitialize(); 

  });
</script>
</body>
</html>
